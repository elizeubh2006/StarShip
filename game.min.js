import*as t from"https://cdn.jsdelivr.net/npm/three@0.176.0/build/three.module.js";import{GLTFLoader as o}from"https://cdn.jsdelivr.net/npm/three@0.176.0/examples/jsm/loaders/GLTFLoader.js";import*as n from"./settings.js";import{initDomElements as e}from"./DomElements.js";const a=!1,l=!0;document.addEventListener("DOMContentLoaded",(()=>{let a=5,l=.3;const i=new t.Clock,{startScreen:r,hud:s,gameOverScreen:c,scoreEl:w,levelEl:d,finalScoreEl:u,btnPlay:h,btnRestart:g,container:f,loadingScreen:p,progressBar:S,settingsBtn:m,settingsMenu:M,muteBtn:y,bgSlider:b,fxSlider:v,expSlider:x,exitBtn:O,parExplosionGain:k,pauseBtn:J,overlay:N}=e();let F=k;window.monitorVars={score:0,level:1,dificuldade:1,hitsToKill:n.BASE_HITS_TO_KILL,aggroFactor:l,playerPosition:{x:0,y:0,z:0}};var j=!1,A=1;let z,E,V,B,D,L=null,C=null,P=null,T=null,G=[],R=[],W=[],q=[],K=null,U=0,H=1,I=.1,Q="start",X=0,Y=0,Z=!1,$={x:0,y:0},_=!1,tt=n.ENEMY_BASE_SPEED,ot=0,nt=0;const et=document.getElementById("topbar");function at(){"play"===Q?et.classList.add("hidden"):et.classList.remove("hidden")}[n.FX_SPAWN,n.FX_COLLECT,n.FX_PLASMA_NOT_HIT,n.BG_MUSIC].forEach((t=>{t.preload="auto",t.load()})),n.BG_MUSIC.loop=!0,n.BG_MUSIC.volume=.02,n.FX_SPAWN.volume=n.FX_COLLECT.volume=1,n.FX_PLASMA_NOT_HIT.volume=.5;const lt=new t.LoadingManager;function it(t){const o=t.cloneNode();o.currentTime=0,o.volume=t.volume,o.muted=t.muted,o.play()}function rt(){K&&z.remove(K),K=T.clone(),K.position.set(n.EARTH_POSITION.x,n.EARTH_POSITION.y,n.EARTH_POSITION.z),z.add(K)}function st(o){const e=new t.BufferGeometry,a=new Float32Array(900),l=new Float32Array(900);for(let t=0;t<300;t++){a[3*t]=o.x,a[3*t+1]=o.y,a[3*t+2]=o.z;const e=2*Math.random()*Math.PI,i=Math.acos(2*Math.random()-1),r=n.EXPLOSION_SPEED*Math.random();l[3*t]=Math.sin(i)*Math.cos(e)*r,l[3*t+1]=Math.sin(i)*Math.sin(e)*r,l[3*t+2]=Math.cos(i)*r}e.setAttribute("position",new t.BufferAttribute(a,3)),e.setAttribute("velocity",new t.BufferAttribute(l,3));const i=new t.PointsMaterial({size:.05,color:16776960,transparent:!0,opacity:1}),r=new t.Points(e,i);z.add(r),q.push(r),console.log("Play fxCrash"),function(){const t=n.CRASH_POOL_AUDIO[ot];t.currentTime=0,t.play(),ot=(ot+1)%n.CRASH_POOL_AUDIO.length}()}function ct(){E.aspect=f.clientWidth/f.clientHeight,E.updateProjectionMatrix(),V.setSize(f.clientWidth,f.clientHeight)}lt.onProgress=(t,o,n)=>{S.value=o/n*100,S.value<98?h.style.display="none":h.style.display=""},lt.onLoad=()=>{p.style.display="none",V.domElement.style.display=""},y.onclick=()=>{const t=!n.BG_MUSIC.muted;[n.BG_MUSIC,n.FX_SPAWN,n.FX_COLLECT,n.FX_PLASMA_NOT_HIT].forEach((o=>o.muted=t)),n.SHOT_POOL_AUDIO.forEach((o=>o.muted=t)),n.CRASH_POOL_AUDIO.forEach((o=>o.muted=t)),y.textContent=t?"ðŸ”‡ Mudo":"ðŸ”Š Som",localStorage.setItem("audioSettings",JSON.stringify({bgVolume:n.BG_MUSIC.volume,fxVolume:n.FX_SPAWN.volume,muted:t}))},b.oninput=()=>{n.BG_MUSIC.volume=parseFloat(b.value);const t=JSON.parse(localStorage.getItem("audioSettings")||"{}");t.bgVolume=n.BG_MUSIC.volume,localStorage.setItem("audioSettings",JSON.stringify(t))},v.oninput=()=>{const t=parseFloat(v.value);n.FX_SPAWN.volume=n.FX_COLLECT.volume=t,n.SHOT_POOL_AUDIO.forEach((o=>o.volume=t)),n.CRASH_POOL_AUDIO.forEach((o=>o.volume=t));const o=JSON.parse(localStorage.getItem("audioSettings")||"{}");o.fxVolume=t,localStorage.setItem("audioSettings",JSON.stringify(o))},x.oninput=()=>{F=parseFloat(x.value),n.CRASH_POOL_AUDIO.forEach((t=>t.volume=v.value*F));const t=JSON.parse(localStorage.getItem("audioSettings")||"{}");t.explosionGain=F,localStorage.setItem("audioSettings",JSON.stringify(t))},O.onclick=()=>location.reload(),J.onclick=()=>{"play"===Q&&(_=!_,J.textContent=_?"â–¶ï¸":"â¸ï¸",N.style.display=_?"block":"none",m.style.display=_?"block":"none",_?n.BG_MUSIC.pause():n.BG_MUSIC.play().catch((()=>{})))},m.onclick=t=>{t.stopPropagation(),M.style.display="block"===M.style.display?"none":"block"},M.onclick=t=>t.stopPropagation(),document.addEventListener("click",(()=>{M.style.display="none"})),window.addEventListener("resize",ct),window.addEventListener("keydown",(t=>{"play"===Q&&L&&("ArrowLeft"!==t.key&&"a"!==t.key||(L.position.x=Math.max(L.position.x-1,-n.BOUND_X)),"ArrowRight"!==t.key&&"d"!==t.key||(L.position.x=Math.min(L.position.x+1,n.BOUND_X)),"ArrowUp"!==t.key&&"w"!==t.key||(L.position.y=Math.min(L.position.y+1,n.BOUND_Y)),"ArrowDown"!==t.key&&"s"!==t.key||(L.position.y=Math.max(L.position.y-1,-n.BOUND_Y)),window.monitorVars.playerPosition={x:L.position.x,y:L.position.y,z:L.position.z})}));if("ontouchstart"in window||navigator.maxTouchPoints>0){let t=0;f.addEventListener("touchend",(o=>{const n=Date.now();n-t<300&&(j=!j),t=n}))}else f.addEventListener("dblclick",(()=>{_||(j=!j)}));function wt(){const t=Math.floor(U/n.PONTOS_PARA_MUDAR_NIVEL)+1;t>H&&(H=t,d.textContent=H,tt=n.ENEMY_BASE_SPEED+.005*(H-1),l=Math.min(l+n.AGGRO_INCREMENT,n.AGGRO_MAX),A+=1,a=n.BASE_HITS_TO_KILL+2*(H-1),window.monitorVars.level=H,window.monitorVars.dificuldade=A,window.monitorVars.hitsToKill=a,window.monitorVars.aggroFactor=l)}function dt(){if(!L)return;const o=new t.SphereGeometry(.07+n.PLASMA_SIZE,8,8),e=new t.MeshBasicMaterial({color:65535}),a=new t.Mesh(o,e);a.position.copy(L.position),a.userData={velocity:new t.Vector3(0,0,-n.PROJECTILE_SPEED)},z.add(a),G.push(a)}f.addEventListener("pointerdown",(t=>{_||"play"===Q&&L&&(Z=!0,$.x=t.clientX,$.y=t.clientY,dt(),it(n.FX_PLASMA_NOT_HIT))})),f.addEventListener("pointermove",(t=>{if(Z&&"play"===Q&&L){const o=(t.clientX-$.x)/100,e=(t.clientY-$.y)/100;L.position.x=Math.max(Math.min(L.position.x+o,n.BOUND_X),-n.BOUND_X),L.position.y=Math.max(Math.min(L.position.y-e,n.BOUND_Y),-n.BOUND_Y),$.x=t.clientX,$.y=t.clientY,window.monitorVars.playerPosition={x:L.position.x,y:L.position.y,z:L.position.z}}})),f.addEventListener("pointerup",(()=>Z=!1)),f.addEventListener("pointerleave",(()=>Z=!1)),h.onclick=()=>{S.value>=98&&(f.requestFullscreen&&document.documentElement.requestFullscreen(),r.style.display="none",s.style.display="flex",Q="play",at(),J.style.display="block",n.BG_MUSIC.play().catch((()=>{})),ht())},g.onclick=()=>location.reload(),window.addEventListener("keydown",(t=>{_||"play"!==Q||" "!==t.key&&"Spacebar"!==t.key||(dt(),it(n.FX_PLASMA_NOT_HIT))}));var ut=0;function ht(){if(ut>n.TIROS_POR_SEGUNDO&&j?(_||"play"!==Q||(dt(),it(n.FX_PLASMA_NOT_HIT)),ut=0):ut++,"start"===Q)return;if(requestAnimationFrame(ht),_)return;"play"===Q&&(X+=I,X>60&&(X=0,function(){if(!P)return;const t=P.clone();t.position.set(Math.random()*(2*n.BOUND_X)-n.BOUND_X,Math.random()*(2*n.BOUND_Y)-n.BOUND_Y,n.INITIAL_COLLECTIBLE_Z),z.add(t),W.push(t)}()),Y+=I,Y>50-A&&(Y=0,function(){if(!C)return;for(let o=0;o<1;o++){let o;do{o=new t.Vector3(Math.random()*(2*n.BOUND_X)-n.BOUND_X,Math.random()*(2*n.BOUND_Y)-n.BOUND_Y,n.INITIAL_ENEMY_Z-10*Math.random())}while(R.some((t=>t.position.distanceTo(o)<n.ENEMY_MIN_DISTANCE)));const e=C.clone();e.userData.elapsedTime=0,e.userData.reactionTime=Math.max(n.MIN_REACTION_TIME,n.BASE_REACTION_TIME-(H-1)*n.REACTION_DECREASE),e.position.copy(o),e.userData.hits=0,z.add(e),R.push(e)}}()));!function(o){R.forEach((n=>{n.userData.elapsedTime+=o;const e=Math.min(n.userData.elapsedTime/n.userData.reactionTime,1),a=(new t.Vector3).subVectors(L.position,n.position).normalize();n.position.x+=a.x*tt*l*e,n.position.y+=a.y*tt*l*e}))}(i.getDelta()),R.forEach((t=>t.position.z+=I)),W.forEach((t=>{t.position.z+=I,t.rotation.y+=n.STAR_ROTATION_SPEED})),G=G.filter((t=>(t.position.add(t.userData.velocity),!(t.position.z<n.INITIAL_ENEMY_Z-50)||(z.remove(t),!1))));const o=B.geometry.attributes.position;for(let t=0;t<o.count;t++)o.array[3*t+2]+=.5,o.array[3*t+2]>10&&(o.array[3*t+2]-=200);o.needsUpdate=!0,K.rotation.y+=n.EARTH_ROTATION_SPEED,K.position.z+=n.PLANET_SPEED,K.position.z>5&&rt(),G.forEach(((o,e)=>{R.forEach(((a,l)=>{if(o.position.distanceTo(a.position)<n.COLLISION_DISTANCE){a.userData.hits++,a.traverse((o=>{o.material&&(o.material.emissive=new t.Color(16777215))})),setTimeout((()=>{a.traverse((o=>{o.material&&(o.material.emissive=new t.Color(0))}))}),50),z.remove(o),G.splice(e,1);const i=n.BASE_HITS_TO_KILL+2*(H-1);a.userData.hits>=i?(st(a.position.clone()),z.remove(a),R.splice(l,1),U+=n.VALOR_INIMIGO,window.monitorVars.score=U,Math.round(U/n.PONTOS_PARA_MUDAR_NIVEL),w.textContent=U,wt()):function(){const t=n.SHOT_POOL_AUDIO[nt];t.currentTime=0,t.play(),nt=(nt+1)%n.SHOT_POOL_AUDIO.length}()}}))})),L&&(R=R.filter((t=>L.position.distanceTo(t.position)<n.COLLISION_DISTANCE?(st(L.position.clone()),z.remove(L),Q="exploding",!1):!(t.position.z>L.position.z+n.ENEMY_PASS_OFFSET_Z&&(z.remove(t),1)))),W=W.filter((t=>L.position.distanceTo(t.position)<n.COLLISION_DISTANCE_COLLECTIBLE?(U+=n.VALOR_ESTRELA,window.monitorVars.score=U,w.textContent=U,z.remove(t),it(n.FX_COLLECT),wt(),!1):!(t.position.z>5&&(z.remove(t),1)))));for(let t=q.length-1;t>=0;t--){const o=q[t],n=o.geometry.attributes.position,e=o.geometry.attributes.velocity;for(let t=0;t<n.count;t++)n.array[3*t]+=e.array[3*t],n.array[3*t+1]+=e.array[3*t+1],n.array[3*t+2]+=e.array[3*t+2];n.needsUpdate=!0,o.material.opacity-=.005,o.material.opacity<=0&&(z.remove(o),q.splice(t,1))}"exploding"===Q&&0===q.length&&(Q="over",s.style.display="none",c.style.display="flex",u.textContent=U,U>0&&localStorage.setItem("highScore",U),at()),V.render(z,E)}"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then((()=>console.log("Service Worker registrado!")));let gt=JSON.parse(localStorage.getItem("audioSettings"));gt||(gt={bgVolume:n.BG_MUSIC.volume,fxVolume:n.FX_SPAWN.volume,muted:!1},localStorage.setItem("audioSettings",JSON.stringify(gt))),gt.explosionGain?F=gt.explosionGain:(gt.explosionGain=F,localStorage.setItem("audioSettings",JSON.stringify(gt)));const{bgVolume:ft,fxVolume:pt,muted:St}=gt;n.BG_MUSIC.volume=ft,b.value=ft,n.FX_SPAWN.volume=n.FX_COLLECT.volume=n.FX_PLASMA_NOT_HIT.volume=pt,n.SHOT_POOL_AUDIO.forEach((t=>t.volume=pt)),n.CRASH_POOL_AUDIO.forEach((t=>t.volume=pt)),v.value=pt,[n.BG_MUSIC,n.FX_SPAWN,n.FX_COLLECT,n.FX_PLASMA_NOT_HIT].forEach((t=>t.muted=St)),n.SHOT_POOL_AUDIO.forEach((t=>t.muted=St)),n.CRASH_POOL_AUDIO.forEach((t=>t.muted=St)),y.textContent=St?"ðŸ”‡ Mudo":"ðŸ”Š Som",function(){z=new t.Scene,E=new t.PerspectiveCamera(60,f.clientWidth/f.clientHeight,.1,200),E.position.set(0,2,5),E.lookAt(0,0,0),V=new t.WebGLRenderer({antialias:!0,alpha:!0}),V.setSize(f.clientWidth,f.clientHeight),V.setClearColor(0,0),V.domElement.style.touchAction="none",V.domElement.style.display="none",f.appendChild(V.domElement);const e=new t.AmbientLight(16777215,15);z.add(e);const a=new t.DirectionalLight(16772778,15);a.position.set(10,20,30),z.add(a);const l=new t.DirectionalLight(16777215,35);l.position.set(0,0,-5),l.intensity=30,l.target.position.set(0,0,-20),z.add(l),z.add(l.target),new t.TextureLoader(lt).load("./images/brightStar.png",(o=>{D=new t.Sprite(new t.SpriteMaterial({map:o})),D.scale.set(n.BRIGHTSTAR_SIZE.x,n.BRIGHTSTAR_SIZE.y,n.BRIGHTSTAR_SIZE.z),D.position.set(n.BRIGHTSTAR_POSITION.x,n.BRIGHTSTAR_POSITION.y,n.BRIGHTSTAR_POSITION.z),z.add(D)}));const i=new Float32Array(3e3);for(let t=0;t<1e3;t++)i[3*t]=100*(Math.random()-.5),i[3*t+1]=100*(Math.random()-.5),i[3*t+2]=200*-Math.random();const r=new t.BufferGeometry;r.setAttribute("position",new t.BufferAttribute(i,3));const s=new t.PointsMaterial({size:.2});B=new t.Points(r,s),z.add(B);const c=new o(lt);c.load("./models/SpaceShip/scene.gltf",(t=>{L=t.scene,L.scale.set(.1+n.PLAYER_SIZE,.1+n.PLAYER_SIZE,.1+n.PLAYER_SIZE),L.position.set(n.PLAYER_START_POSITION.x,n.PLAYER_START_POSITION.y,n.PLAYER_START_POSITION.z),z.add(L)})),c.load("./models/Enemy/scene.gltf",(t=>{C=t.scene,C.scale.set(n.ENEMY_SIZE.x,n.ENEMY_SIZE.y,n.ENEMY_SIZE.z),t.scene.traverse((t=>{t.isMesh&&t.material.isMeshStandardMaterial&&(t.material.metalness=1,t.material.roughness=.3,t.material.envMapIntensity=5)}))})),c.load("./models/Collectibles/scene.gltf",(t=>{P=t.scene,P.scale.set(n.COLLECTIBLE_SIZE.x,n.COLLECTIBLE_SIZE.y,n.COLLECTIBLE_SIZE.z),t.scene.traverse((t=>{t.isMesh&&t.material.isMeshStandardMaterial&&(t.material.metalness=1,t.material.roughness=0,t.material.envMapIntensity=1)}))})),c.load("models/Earth/earth.gltf",(t=>{T=t.scene,T.scale.set(n.EARTH_SIZE,n.EARTH_SIZE,n.EARTH_SIZE),rt()}))}(),window.open("monitor.html","Monitor","width=300,height=400,resizable=yes,scrollbars=yes"),ct()}));